<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard PI - Moyopampa y Callahuanca</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.26.0/plotly.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        .section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .section h2 {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .chart-container {
            width: 100%;
            height: 500px;
            margin-bottom: 30px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .status.loading {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info-panel {
            background: #ecf0f1;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        .refresh-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin-bottom: 20px;
        }
        .refresh-btn:hover {
            background: #2980b9;
        }
        .refresh-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üè≠ Dashboard PI - Centrales Hidroel√©ctricas</h1>
        
        <div class="info-panel">
            <button class="refresh-btn" onclick="refreshData()">üîÑ Actualizar Datos</button>
            <div id="last-update">√öltima actualizaci√≥n: Cargando...</div>
        </div>
        
        <div id="status" class="status loading">üìä Cargando datos desde GitHub...</div>
        
        <!-- Secci√≥n Moyopampa -->
        <div class="section">
            <h2>üåä Central Moyopampa</h2>
            <div id="moyopampa-caudal" class="chart-container"></div>
            <div id="moyopampa-potencia" class="chart-container"></div>
        </div>
        
        <!-- Secci√≥n Callahuanca -->
        <div class="section">
            <h2>‚ö° Central Callahuanca</h2>
            <div id="callahuanca-caudal" class="chart-container"></div>
            <div id="callahuanca-potencia" class="chart-container"></div>
        </div>
    </div>

    <script>
        // Configuraci√≥n para los gr√°ficos
        const plotConfig = {
            responsive: true,
            displayModeBar: true,
            modeBarButtonsToRemove: ['pan2d', 'select2d', 'lasso2d', 'autoScale2d'],
            displaylogo: false
        };

        // Funci√≥n para convertir CSV a JSON
        function csvToJson(csv) {
            const lines = csv.trim().split('\n');
            const headers = lines[0].split(',');
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',');
                const obj = {};
                headers.forEach((header, index) => {
                    obj[header.trim()] = values[index] ? values[index].trim() : null;
                });
                data.push(obj);
            }
            return data;
        }

        // Funci√≥n para cargar datos desde GitHub
        async function loadDataFromGitHub(filename) {
            try {
                const response = await fetch(`https://raw.githubusercontent.com/isaactj11/DatosPIGit/main/data/${filename}`);
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }
                const csvData = await response.text();
                return csvToJson(csvData);
            } catch (error) {
                console.error(`Error cargando ${filename}:`, error);
                return null;
            }
        }

        // Funci√≥n para crear gr√°fico de caudal
        function createCaudalChart(data, divId, title) {
            if (!data || data.length === 0) {
                document.getElementById(divId).innerHTML = '<p>No hay datos disponibles para mostrar.</p>';
                return;
            }

            const timestamps = data.map(row => row.timestamp);
            const traces = [];

            // Buscar columnas de caudal
            const headers = Object.keys(data[0]);
            const caudalColumns = headers.filter(h => h.includes('Caudal'));

            caudalColumns.forEach(col => {
                const values = data.map(row => row[col] ? parseFloat(row[col]) : null);
                traces.push({
                    x: timestamps,
                    y: values,
                    name: col.replace('Caudal_', ''),
                    type: 'scatter',
                    mode: 'lines+markers',
                    line: { width: 2 },
                    marker: { size: 4 }
                });
            });

            const layout = {
                title: {
                    text: title,
                    font: { size: 18, color: '#2c3e50' }
                },
                xaxis: {
                    title: 'Tiempo',
                    type: 'date',
                    tickformat: '%H:%M\n%d/%m'
                },
                yaxis: {
                    title: 'Caudal (m¬≥/s)',
                    gridcolor: '#ecf0f1'
                },
                legend: {
                    orientation: 'h',
                    y: -0.2
                },
                margin: { l: 80, r: 40, t: 80, b: 100 },
                plot_bgcolor: 'white',
                paper_bgcolor: 'white'
            };

            Plotly.newPlot(divId, traces, layout, plotConfig);
        }

        // Funci√≥n para crear gr√°fico de potencia
        function createPotenciaChart(data, divId, title) {
            if (!data || data.length === 0) {
                document.getElementById(divId).innerHTML = '<p>No hay datos disponibles para mostrar.</p>';
                return;
            }

            const timestamps = data.map(row => row.timestamp);
            const traces = [];

            // Buscar columnas de potencia
            const headers = Object.keys(data[0]);
            const potenciaColumns = headers.filter(h => h.includes('Potencia'));

            potenciaColumns.forEach(col => {
                const values = data.map(row => row[col] ? parseFloat(row[col]) : null);
                traces.push({
                    x: timestamps,
                    y: values,
                    name: col.replace('_Potencia', ''),
                    type: 'scatter',
                    mode: 'lines+markers',
                    line: { width: 2 },
                    marker: { size: 4 }
                });
            });

            const layout = {
                title: {
                    text: title,
                    font: { size: 18, color: '#2c3e50' }
                },
                xaxis: {
                    title: 'Tiempo',
                    type: 'date',
                    tickformat: '%H:%M\n%d/%m'
                },
                yaxis: {
                    title: 'Potencia (MW)',
                    gridcolor: '#ecf0f1'
                },
                legend: {
                    orientation: 'h',
                    y: -0.2
                },
                margin: { l: 80, r: 40, t: 80, b: 100 },
                plot_bgcolor: 'white',
                paper_bgcolor: 'white'
            };

            Plotly.newPlot(divId, traces, layout, plotConfig);
        }

        // Funci√≥n para actualizar el estado
        function updateStatus(message, type = 'loading') {
            const statusElement = document.getElementById('status');
            statusElement.textContent = message;
            statusElement.className = `status ${type}`;
        }

        // Funci√≥n para cargar todos los datos
        async function loadAllData() {
            updateStatus('üìä Cargando datos desde GitHub...', 'loading');
            
            try {
                // Cargar datos en paralelo
                const [moyopampaData, callahuancaData] = await Promise.all([
                    loadDataFromGitHub('moyopampa_data.csv'),
                    loadDataFromGitHub('callahuanca_data.csv')
                ]);

                // Crear gr√°ficos de Moyopampa
                if (moyopampaData) {
                    createCaudalChart(moyopampaData, 'moyopampa-caudal', 'üìà Caudal - Moyopampa');
                    createPotenciaChart(moyopampaData, 'moyopampa-potencia', '‚ö° Potencia - Moyopampa');
                }

                // Crear gr√°ficos de Callahuanca
                if (callahuancaData) {
                    createCaudalChart(callahuancaData, 'callahuanca-caudal', 'üìà Caudal - Callahuanca');
                    createPotenciaChart(callahuancaData, 'callahuanca-potencia', '‚ö° Potencia - Callahuanca');
                }

                updateStatus('‚úÖ Datos cargados exitosamente', 'success');
                document.getElementById('last-update').textContent = `√öltima actualizaci√≥n: ${new Date().toLocaleString()}`;
                
            } catch (error) {
                console.error('Error cargando datos:', error);
                updateStatus('‚ùå Error cargando datos desde GitHub', 'error');
            }
        }

        // Funci√≥n para refrescar datos
        async function refreshData() {
            const btn = document.querySelector('.refresh-btn');
            btn.disabled = true;
            btn.textContent = 'üîÑ Actualizando...';
            
            await loadAllData();
            
            btn.disabled = false;
            btn.textContent = 'üîÑ Actualizar Datos';
        }

        // Cargar datos al inicio
        document.addEventListener('DOMContentLoaded', loadAllData);

        // Auto-refresh cada 5 minutos
        setInterval(loadAllData, 5 * 60 * 1000);
    </script>
</body>
</html>
