<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Datos PI - Moyopampa y Calllahuanca</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.26.0/plotly.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #2c3e50;
            margin: 0;
            font-size: 2.5em;
        }

        .connection-status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            margin-top: 10px;
            font-weight: bold;
            font-size: 0.9em;
        }

        .connected {
            background: #2ecc71;
            color: white;
        }

        .disconnected {
            background: #e74c3c;
            color: white;
        }

        .connecting {
            background: #f39c12;
            color: white;
        }

        .stations-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .station-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }

        .station-title {
            font-size: 1.5em;
            font-weight: bold;
            text-align: center;
            margin-bottom: 20px;
            color: #2c3e50;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .moyopampa .station-title {
            color: #3498db;
        }

        .calllahuanca .station-title {
            color: #e74c3c;
        }

        .chart-container {
            margin-bottom: 20px;
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .chart-title {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .controls {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .control-group label {
            font-weight: bold;
            color: #2c3e50;
            min-width: 120px;
        }

        select, button {
            padding: 8px 15px;
            border: 2px solid #3498db;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            color: #2c3e50;
        }

        button {
            background: #3498db;
            color: white;
            cursor: pointer;
            transition: background 0.3s;
        }

        button:hover {
            background: #2980b9;
        }

        button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }

        .last-update {
            text-align: center;
            color: #7f8c8d;
            font-size: 0.9em;
            margin-top: 20px;
        }

        .loading {
            text-align: center;
            color: #7f8c8d;
            font-size: 1.1em;
            margin: 50px 0;
        }

        @media (max-width: 768px) {
            .stations-container {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .control-group {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .control-group label {
                min-width: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Monitoreo de Estaciones PI</h1>
            <p>Moyopampa y Calllahuanca - Datos en Tiempo Real</p>
            <div id="connectionStatus" class="connection-status connecting">Conectando...</div>
        </div>

        <div class="controls">
            <div class="control-group">
                <label for="timeRange">Rango de Tiempo:</label>
                <select id="timeRange">
                    <option value="1">Última hora</option>
                    <option value="6">Últimas 6 horas</option>
                    <option value="12">Últimas 12 horas</option>
                    <option value="24" selected>Últimas 24 horas</option>
                    <option value="48">Últimas 48 horas</option>
                    <option value="168">Última semana</option>
                </select>
            </div>
            <div class="control-group">
                <button id="refreshBtn">Actualizar Datos</button>
                <button id="autoRefreshBtn">Auto-actualizar: ON</button>
            </div>
        </div>

        <div class="stations-container">
            <div class="station-card moyopampa">
                <div class="station-title">Moyopampa</div>
                <div class="chart-container">
                    <div class="chart-title">Nivel de Agua (m)</div>
                    <div id="moyopampa-nivel" style="height: 300px;"></div>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Caudal (m³/s)</div>
                    <div id="moyopampa-caudal" style="height: 300px;"></div>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Temperatura (°C)</div>
                    <div id="moyopampa-temperatura" style="height: 300px;"></div>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Precipitación (mm)</div>
                    <div id="moyopampa-precipitacion" style="height: 300px;"></div>
                </div>
            </div>

            <div class="station-card calllahuanca">
                <div class="station-title">Calllahuanca</div>
                <div class="chart-container">
                    <div class="chart-title">Nivel de Agua (m)</div>
                    <div id="calllahuanca-nivel" style="height: 300px;"></div>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Caudal (m³/s)</div>
                    <div id="calllahuanca-caudal" style="height: 300px;"></div>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Temperatura (°C)</div>
                    <div id="calllahuanca-temperatura" style="height: 300px;"></div>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Precipitación (mm)</div>
                    <div id="calllahuanca-precipitacion" style="height: 300px;"></div>
                </div>
            </div>
        </div>

        <div class="last-update" id="lastUpdate">
            Última actualización: --
        </div>
    </div>

    <script>
        class PIDataClient {
            constructor() {
                this.ws = null;
                this.reconnectAttempts = 0;
                this.maxReconnectAttempts = 5;
                this.reconnectInterval = 3000;
                this.isAutoRefresh = true;
                this.autoRefreshInterval = null;
                
                this.stationData = {
                    moyopampa: {},
                    calllahuanca: {}
                };
                
                this.colors = {
                    moyopampa: '#3498db',
                    calllahuanca: '#e74c3c'
                };
                
                this.init();
            }
            
            init() {
                this.setupEventListeners();
                this.connect();
                this.startAutoRefresh();
            }
            
            setupEventListeners() {
                document.getElementById('refreshBtn').addEventListener('click', () => {
                    this.requestData();
                });
                
                document.getElementById('autoRefreshBtn').addEventListener('click', () => {
                    this.toggleAutoRefresh();
                });
                
                document.getElementById('timeRange').addEventListener('change', () => {
                    this.requestData();
                });
            }
            
            connect() {
                try {
                    this.ws = new WebSocket('ws://localhost:8765');
                    
                    this.ws.onopen = () => {
                        console.log('Conectado al servidor WebSocket');
                        this.updateConnectionStatus('connected');
                        this.reconnectAttempts = 0;
                    };
                    
                    this.ws.onmessage = (event) => {
                        try {
                            const data = JSON.parse(event.data);
                            this.handleMessage(data);
                        } catch (error) {
                            console.error('Error parseando mensaje:', error);
                        }
                    };
                    
                    this.ws.onclose = () => {
                        console.log('Conexión WebSocket cerrada');
                        this.updateConnectionStatus('disconnected');
                        this.attemptReconnect();
                    };
                    
                    this.ws.onerror = (error) => {
                        console.error('Error WebSocket:', error);
                        this.updateConnectionStatus('disconnected');
                    };
                    
                } catch (error) {
                    console.error('Error conectando:', error);
                    this.updateConnectionStatus('disconnected');
                    this.attemptReconnect();
                }
            }
            
            attemptReconnect() {
                if (this.reconnectAttempts < this.maxReconnectAttempts) {
                    this.reconnectAttempts++;
                    console.log(`Intentando reconectar... (${this.reconnectAttempts}/${this.maxReconnectAttempts})`);
                    
                    setTimeout(() => {
                        this.connect();
                    }, this.reconnectInterval);
                } else {
                    console.error('Máximo número de intentos de reconexión alcanzado');
                }
            }
            
            updateConnectionStatus(status) {
                const statusElement = document.getElementById('connectionStatus');
                statusElement.className = `connection-status ${status}`;
                
                switch (status) {
                    case 'connected':
                        statusElement.textContent = 'Conectado';
                        break;
                    case 'disconnected':
                        statusElement.textContent = 'Desconectado';
                        break;
                    case 'connecting':
                        statusElement.textContent = 'Conectando...';
                        break;
                }
            }
            
            handleMessage(data) {
                switch (data.type) {
                    case 'initial_data':
                        this.processStationData(data.stations);
                        break;
                    case 'data_update':
                        this.processStationData(data.stations);
                        break;
                    case 'station_data':
                        this.processStationData({ [data.station.station]: data.station });
                        break;
                    case 'pong':
                        console.log('Pong recibido');
                        break;
                }
            }
            
            processStationData(stations) {
                Object.keys(stations).forEach(stationName => {
                    const stationData = stations[stationName];
                    this.stationData[stationName] = stationData.data;
                    this.updateCharts(stationName);
                });
                
                this.updateLastUpdateTime();
            }
            
            updateCharts(stationName) {
                const data = this.stationData[stationName];
                if (!data) return;
                
                // Mapeo de parámetros
                const parameters = {
                    nivel_agua: { name: 'nivel', unit: 'm', color: '#3498db' },
                    caudal: { name: 'caudal', unit: 'm³/s', color: '#2ecc71' },
                    temperatura: { name: 'temperatura', unit: '°C', color: '#e74c3c' },
                    precipitacion: { name: 'precipitacion', unit: 'mm', color: '#9b59b6' }
                };
                
                Object.keys(parameters).forEach(param => {
                    if (data[param]) {
                        const paramData = data[param];
                        const paramConfig = parameters[param];
                        
                        this.createTimeSeriesChart(
                            `${stationName}-${paramConfig.name}`,
                            paramData,
                            paramConfig.unit,
                            paramConfig.color
                        );
                    }
                });
            }
            
            createTimeSeriesChart(elementId, data, unit, color) {
                const x = data.map(d => new Date(d.timestamp));
                const y = data.map(d => d.value);
                
                const trace = {
                    x: x,
                    y: y,
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: unit,
                    line: { color: color, width: 2 },
                    marker: { color: color, size: 4 },
                    hovertemplate: '<b>%{y:.2f} ' + unit + '</b><br>' +
                                  'Tiempo: %{x}<br>' +
                                  '<extra></extra>'
                };
                
                const layout = {
                    margin: { l: 50, r: 20, b: 50, t: 20 },
                    xaxis: {
                        title: 'Tiempo',
                        type: 'date',
                        tickformat: '%H:%M<br>%d/%m',
                        gridcolor: '#ecf0f1',
                        linecolor: '#bdc3c7'
                    },
                    yaxis: {
                        title: unit,
                        gridcolor: '#ecf0f1',
                        linecolor: '#bdc3c7'
                    },
                    plot_bgcolor: '#ffffff',
                    paper_bgcolor: '#ffffff',
                    font: { family: 'Segoe UI', size: 12 },
                    hovermode: 'closest',
                    showlegend: false
                };
                
                const config = {
                    responsive: true,
                    displayModeBar: true,
                    displaylogo: false,
                    modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d', 'autoScale2d']
                };
                
                Plotly.newPlot(elementId, [trace], layout, config);
            }
            
            requestData() {
                if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                    const hours = parseInt(document.getElementById('timeRange').value);
                    
                    // Solicitar datos para ambas estaciones
                    ['moyopampa', 'calllahuanca'].forEach(station => {
                        this.ws.send(JSON.stringify({
                            type: 'request_data',
                            station: station,
                            hours_back: hours
                        }));
                    });
                } else {
                    console.warn('WebSocket no está conectado');
                }
            }
            
            toggleAutoRefresh() {
                this.isAutoRefresh = !this.isAutoRefresh;
                const btn = document.getElementById('autoRefreshBtn');
                
                if (this.isAutoRefresh) {
                    btn.textContent = 'Auto-actualizar: ON';
                    btn.style.background = '#2ecc71';
                    this.startAutoRefresh();
                } else {
                    btn.textContent = 'Auto-actualizar: OFF';
                    btn.style.background = '#e74c3c';
                    this.stopAutoRefresh();
                }
            }
            
            startAutoRefresh() {
                if (this.autoRefreshInterval) {
                    clearInterval(this.autoRefreshInterval);
                }
                
                this.autoRefreshInterval = setInterval(() => {
                    if (this.isAutoRefresh) {
                        this.requestData();
                    }
                }, 60000); // Actualizar cada minuto
            }
            
            stopAutoRefresh() {
                if (this.autoRefreshInterval) {
                    clearInterval(this.autoRefreshInterval);
                    this.autoRefreshInterval = null;
                }
            }
            
            updateLastUpdateTime() {
                const now = new Date();
                const timeString = now.toLocaleString('es-PE', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                
                document.getElementById('lastUpdate').textContent = `Última actualización: ${timeString}`;
            }
            
            sendPing() {
                if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                    this.ws.send(JSON.stringify({ type: 'ping' }));
                }
            }
        }

        // Inicializar cliente cuando se carga la página
        document.addEventListener('DOMContentLoaded', () => {
            window.piClient = new PIDataClient();
            
            // Enviar ping cada 30 segundos para mantener la conexión
            setInterval(() => {
                if (window.piClient) {
                    window.piClient.sendPing();
                }
            }, 30000);
        });

        // Manejar cierre de ventana
        window.addEventListener('beforeunload', () => {
            if (window.piClient && window.piClient.ws) {
                window.piClient.ws.close();
            }
        });
    </script>
</body>
</html>
