<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard PI - Moyopampa y Callahuanca</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.24.1/plotly.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        button {
            padding: 12px 24px;
            font-size: 16px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        button.primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        button.secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        
        select {
            padding: 10px 15px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 25px;
            background: white;
            cursor: pointer;
            transition: border-color 0.3s ease;
        }
        
        select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .status {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 10px;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .status.connected {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }
        
        .status.disconnected {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            color: white;
        }
        
        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .chart-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        
        .chart-card:hover {
            transform: translateY(-5px);
        }
        
        .chart-title {
            font-size: 1.4em;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
            text-align: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .current-values {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .values-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .value-item {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .value-label {
            font-size: 0.9em;
            margin-bottom: 5px;
        }
        
        .value-number {
            font-size: 1.4em;
            font-weight: bold;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 1.2em;
        }
        
        @media (max-width: 768px) {
            .charts-container {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
            
            .values-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üè≠ Dashboard PI - Moyopampa y Callahuanca</h1>
        
        <div class="controls">
            <div class="control-group">
                <label for="plantSelect" style="color: white; font-weight: bold;">Planta:</label>
                <select id="plantSelect">
                    <option value="Moyopampa">Moyopampa</option>
                    <option value="Callahuanca">Callahuanca</option>
                </select>
            </div>
            
            <button id="connectBtn" class="primary">üîå Conectar</button>
            <button id="refreshBtn" class="secondary">üîÑ Actualizar</button>
        </div>
        
        <div id="status" class="status disconnected">
            ‚ùå Desconectado del servidor WebSocket
        </div>
        
        <div class="current-values">
            <h3 style="text-align: center; color: #333;">üìä Valores Actuales</h3>
            <div id="currentValues" class="values-grid">
                <div class="loading">Cargando valores actuales...</div>
            </div>
        </div>
        
        <div class="charts-container">
            <div class="chart-card">
                <div class="chart-title">‚ö° Potencias</div>
                <div id="powerChart"></div>
            </div>
            
            <div class="chart-card">
                <div class="chart-title">üíß Caudales</div>
                <div id="flowChart"></div>
            </div>
        </div>
    </div>

    <script>
        class PIWebSocketClient {
            constructor() {
                this.ws = null;
                this.isConnected = false;
                this.currentPlant = 'Moyopampa';
                this.reconnectAttempts = 0;
                this.maxReconnectAttempts = 5;
                this.reconnectDelay = 3000;
                
                this.initializeEventListeners();
                this.initializePlotly();
            }
            
            initializeEventListeners() {
                document.getElementById('connectBtn').addEventListener('click', () => this.connect());
                document.getElementById('refreshBtn').addEventListener('click', () => this.requestData());
                document.getElementById('plantSelect').addEventListener('change', (e) => {
                    this.currentPlant = e.target.value;
                    this.requestData();
                });
            }
            
            initializePlotly() {
                const config = {
                    responsive: true,
                    displayModeBar: true,
                    modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d'],
                    displaylogo: false
                };
                
                const layout = {
                    height: 400,
                    showlegend: true,
                    hovermode: 'x unified',
                    font: { family: 'Segoe UI, Arial' },
                    plot_bgcolor: '#f8f9fa',
                    paper_bgcolor: 'white',
                    xaxis: {
                        title: 'Tiempo',
                        type: 'date',
                        gridcolor: '#e9ecef'
                    },
                    yaxis: {
                        title: 'Valor',
                        gridcolor: '#e9ecef'
                    },
                    margin: { l: 60, r: 40, t: 40, b: 60 }
                };
                
                Plotly.newPlot('powerChart', [], layout, config);
                Plotly.newPlot('flowChart', [], layout, config);
            }
            
            connect() {
                if (this.isConnected) {
                    this.disconnect();
                    return;
                }
                
                try {
                    this.ws = new WebSocket('ws://localhost:8765');
                    
                    this.ws.onopen = () => {
                        this.isConnected = true;
                        this.reconnectAttempts = 0;
                        this.updateStatus('connected', '‚úÖ Conectado al servidor PI');
                        document.getElementById('connectBtn').textContent = 'üîå Desconectar';
                        document.getElementById('connectBtn').className = 'secondary';
                        
                        // Solicitar datos iniciales
                        this.requestData();
                        this.requestCurrentValues();
                    };
                    
                    this.ws.onmessage = (event) => {
                        this.handleMessage(JSON.parse(event.data));
                    };
                    
                    this.ws.onclose = () => {
                        this.isConnected = false;
                        this.updateStatus('disconnected', '‚ùå Desconectado del servidor');
                        document.getElementById('connectBtn').textContent = 'üîå Conectar';
                        document.getElementById('connectBtn').className = 'primary';
                        
                        // Intentar reconectar
                        this.attemptReconnect();
                    };
                    
                    this.ws.onerror = (error) => {
                        console.error('WebSocket error:', error);
                        this.updateStatus('disconnected', '‚ùå Error de conexi√≥n');
                    };
                    
                } catch (error) {
                    console.error('Error connecting:', error);
                    this.updateStatus('disconnected', '‚ùå Error al conectar');
                }
            }
            
            disconnect() {
                if (this.ws) {
                    this.ws.close();
                    this.ws = null;
                }
                this.isConnected = false;
            }
            
            attemptReconnect() {
                if (this.reconnectAttempts < this.maxReconnectAttempts) {
                    this.reconnectAttempts++;
                    this.updateStatus('disconnected', `üîÑ Reintentando conexi√≥n (${this.reconnectAttempts}/${this.maxReconnectAttempts})...`);
                    
                    setTimeout(() => {
                        this.connect();
                    }, this.reconnectDelay);
                } else {
                    this.updateStatus('disconnected', '‚ùå No se pudo reconectar. Intente manualmente.');
                }
            }
            
            requestData() {
                if (this.isConnected && this.ws) {
                    this.ws.send(JSON.stringify({
                        action: 'get_data',
                        plant: this.currentPlant
                    }));
                }
            }
            
            requestCurrentValues() {
                if (this.isConnected && this.ws) {
                    this.ws.send(JSON.stringify({
                        action: 'get_current_values'
                    }));
                }
            }
            
            handleMessage(message) {
                switch (message.action) {
                    case 'data_update':
                        this.updateCharts(message.data);
                        break;
                    case 'current_values':
                        this.updateCurrentValues(message.data);
                        break;
                    default:
                        console.log('Unknown message type:', message.action);
                }
            }
            
            updateCharts(data) {
                if (!data || !data.data) return;
                
                const powerTraces = [];
                const flowTraces = [];
                
                // Colores para las trazas
                const colors = ['#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe', '#00f2fe'];
                let colorIndex = 0;
                
                Object.entries(data.data).forEach(([name, values]) => {
                    if (!values.timestamps || !values.values) return;
                    
                    const trace = {
                        x: values.timestamps,
                        y: values.values,
                        name: name,
                        type: 'scatter',
                        mode: 'lines+markers',
                        line: { 
                            width: 2, 
                            color: colors[colorIndex % colors.length]
                        },
                        marker: { size: 4 },
                        hovertemplate: '<b>%{fullData.name}</b><br>' +
                                     'Tiempo: %{x}<br>' +
                                     'Valor: %{y:.2f}<br>' +
                                     '<extra></extra>'
                    };
                    
                    if (name.includes('Potencia')) {
                        powerTraces.push(trace);
                    } else if (name.includes('Caudal')) {
                        flowTraces.push(trace);
                    }
                    
                    colorIndex++;
                });
                
                // Actualizar gr√°fico de potencias
                if (powerTraces.length > 0) {
                    const powerLayout = {
                        title: `Potencias - ${data.plant}`,
                        yaxis: { title: 'Potencia (MW)' },
                        xaxis: { title: 'Tiempo' }
                    };
                    
                    Plotly.react('powerChart', powerTraces, powerLayout);
                }
                
                // Actualizar gr√°fico de caudales
                if (flowTraces.length > 0) {
                    const flowLayout = {
                        title: `Caudales - ${data.plant}`,
                        yaxis: { title: 'Caudal (m¬≥/s)' },
                        xaxis: { title: 'Tiempo' }
                    };
                    
                    Plotly.react('flowChart', flowTraces, flowLayout);
                }
            }
            
            updateCurrentValues(data) {
                const container = document.getElementById('currentValues');
                container.innerHTML = '';
                
                // Filtrar valores seg√∫n la planta seleccionada
                const filteredData = {};
                Object.entries(data).forEach(([key, value]) => {
                    if (key.toLowerCase().includes(this.currentPlant.toLowerCase())) {
                        filteredData[key] = value;
                    }
                });
                
                Object.entries(filteredData).forEach(([name, value]) => {
                    const valueItem = document.createElement('div');
                    valueItem.className = 'value-item';
                    
                    const formattedValue = value !== null ? 
                        (typeof value === 'number' ? value.toFixed(2) : value) : 
                        'N/A';
                    
                    const unit = name.includes('Potencia') ? 'MW' : 
                               name.includes('Caudal') ? 'm¬≥/s' : '';
                    
                    valueItem.innerHTML = `
                        <div class="value-label">${name}</div>
                        <div class="value-number">${formattedValue} ${unit}</div>
                    `;
                    
                    container.appendChild(valueItem);
                });
                
                if (Object.keys(filteredData).length === 0) {
                    container.innerHTML = '<div class="loading">No hay datos disponibles para esta planta</div>';
                }
            }
            
            updateStatus(type, message) {
                const statusEl = document.getElementById('status');
                statusEl.className = `status ${type}`;
                statusEl.textContent = message;
            }
        }
        
        // Inicializar cliente WebSocket
        const client = new PIWebSocketClient();
